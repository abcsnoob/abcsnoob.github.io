<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Chat App with hCaptcha & Google Login</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    .auth-section input {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 200px;
    }

    .auth-section button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }

    .auth-section button:hover {
      background-color: #2980b9;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <header>
    <h1>Supabase Chat App</h1>
  </header>

  <!-- Authentication Section -->
  <div class="auth-section" id="authSection">
    <div id="signUpForm">
      <input type="email" id="signUpEmail" placeholder="Email" required>
      <input type="password" id="signUpPassword" placeholder="Password" required>
      <div class="h-captcha" data-sitekey="9e92809a-9836-46ae-91e6-5968d65c2120"></div>
      <button onclick="signUp()">Sign Up</button>
    </div>

    <div id="signInForm">
      <input type="email" id="signInEmail" placeholder="Email" required>
      <input type="password" id="signInPassword" placeholder="Password" required>
      <div class="h-captcha" data-sitekey="9e92809a-9836-46ae-91e6-5968d65c2120"></div>
      <button onclick="signIn()">Sign In</button>
      <button onclick="signInWithGoogle()">Sign In with Google</button>
    </div>

    <button id="logoutBtn" style="display: none;" onclick="logout()">Logout</button>
  </div>

  <!-- User Section -->
  <div id="userSection" style="display: none;">
    <h2>Welcome to your dashboard</h2>
    <div id="messages"></div>
    <div id="spinner" class="spinner"></div>
    <button onclick="loadMessages()">Load Messages</button>

    <div id="groupSection">
      <h2>Join a Group</h2>
      <input type="text" id="groupSearch" placeholder="Enter Group Code">
      <button onclick="joinGroup()">Join Group</button>
      <div id="groupsList"></div>
    </div>
  </div>

  <script>
    const supabase = createClient('https://kakbqeqyihbgioevzsrg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtha2JxZXF5aWhiZ2lvZXZ6c3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2ODc4NjksImV4cCI6MjA1OTI2Mzg2OX0.LRiRpup89IKy1m4SrqikyVQFEbDK8Kbo1NvOJCePCTM');

    let currentUser = null;

    document.getElementById('signInForm').style.display = 'block';
    document.getElementById('signUpForm').style.display = 'block';
    document.getElementById('userSection').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';

    // Đăng ký người dùng
    async function signUp() {
      const email = document.getElementById('signUpEmail').value;
      const password = document.getElementById('signUpPassword').value;
      const hcaptchaToken = hcaptcha.getResponse();

      if (!hcaptchaToken) {
        alert("Please complete the CAPTCHA.");
        return;
      }

      const { user, error } = await supabase.auth.signUp({ email, password });

      if (user) {
        console.log('User created:', user);
        currentUser = user;
        document.getElementById('signUpForm').style.display = 'none';
        document.getElementById('signInForm').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        loadGroups();
      } else {
        console.error('Error signing up:', error.message);
      }
    }

    // Đăng nhập người dùng
    async function signIn() {
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      const hcaptchaToken = hcaptcha.getResponse();

      if (!hcaptchaToken) {
        alert("Please complete the CAPTCHA.");
        return;
      }

      const { user, error } = await supabase.auth.signIn({ email, password });

      if (user) {
        console.log('User logged in:', user);
        currentUser = user;
        document.getElementById('signInForm').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        loadMessages();
        loadGroups();
      } else {
        console.error('Error logging in:', error.message);
      }
    }

    // Đăng nhập với Google
    async function signInWithGoogle() {
      const { user, error } = await supabase.auth.signIn({
        provider: 'google',
      });

      if (user) {
        console.log('User logged in with Google:', user);
        currentUser = user;
        document.getElementById('signInForm').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        loadMessages();
        loadGroups();
      } else {
        console.error('Error logging in with Google:', error.message);
      }
    }

    // Đăng xuất người dùng
    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      document.getElementById('signInForm').style.display = 'block';
      document.getElementById('userSection').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
    }

    // Tải tin nhắn
    async function loadMessages() {
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';

      const { data, error } = await supabase.from('messages').select('*');
      spinner.style.display = 'none';

      if (error) {
        console.error('Error loading messages:', error.message);
        return;
      }

      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      data.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.textContent = message.content;
        messagesContainer.appendChild(messageElement);
      });
    }

    // Tham gia nhóm
    async function joinGroup() {
      const groupCode = document.getElementById('groupSearch').value;
      const { data, error } = await supabase.from('groups').select('*').eq('code', groupCode);

      if (data.length === 0) {
        alert('Group not found!');
        return;
      }

      const group = data[0];
      alert(`Joined group: ${group.name}`);
      loadGroups();
    }

    // Tải danh sách nhóm
    async function loadGroups() {
      const { data, error } = await supabase.from('groups').select('*');

      if (error) {
        console.error('Error loading groups:', error.message);
        return;
      }

      const groupsList = document.getElementById('groupsList');
      groupsList.innerHTML = '';
      data.forEach(group => {
        const groupElement = document.createElement('div');
        groupElement.textContent = group.name;
        groupsList.appendChild(groupElement);
      });
    }
  </script>
</body>
</html>
