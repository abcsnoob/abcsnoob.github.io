<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDtcs0XkNhf7yFRTzPY-A9WYet35YjQVT8",
        authDomain: "abc-s-noob.firebaseapp.com",
        projectId: "abc-s-noob",
        storageBucket: "abc-s-noob.appspot.com",
        messagingSenderId: "196660846002",
        appId: "1:196660846002:web:ce129820f388cc838658ab",
        measurementId: "G-LG5SWH89MG"
    };
    firebase.initializeApp(firebaseConfig);
    
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    let localStream;
    let peerConnections = {};
    let currentRoom = "general_room"; // Tạo room mặc định

    // DOM elements
    const googleSignInButton = document.getElementById('googleSignInButton');
    const muteButton = document.getElementById('muteButton');
    const leaveButton = document.getElementById('leaveButton');
    const chatSection = document.getElementById('chat-section');
    const authSection = document.getElementById('auth-section');
    const voiceTab = document.getElementById('voiceTab');
    const statusDiv = document.getElementById('status');

    // Firebase Auth - Sign in with Google
    googleSignInButton.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                const user = result.user;
                statusDiv.innerHTML = `Logged in as ${user.displayName}`;
                authSection.classList.add('hidden');
                chatSection.classList.remove('hidden');
                joinRoom(); // Tự động tham gia phòng trò chuyện
            }).catch((error) => {
                console.error("Error during Google sign-in: ", error);
            });
    });

    // Join Room (phòng trò chuyện chung)
    function joinRoom() {
        chatSection.classList.add('hidden');
        voiceTab.classList.remove('hidden');
        // Thiết lập WebRTC cho trò chuyện âm thanh
        setupWebRTC();
    }

    // WebRTC setup để xử lý trò chuyện âm thanh giữa người dùng
    function setupWebRTC() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then((stream) => {
                localStream = stream;
                const audioTrack = localStream.getAudioTracks()[0];

                // Tạo kết nối peer và xử lý ICE candidates
                const peerConnection = new RTCPeerConnection();
                peerConnection.addTrack(audioTrack);

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Gửi ICE candidate cho người khác qua Firestore
                        firestore.collection("rooms").doc(currentRoom).collection("candidates")
                            .add({
                                candidate: event.candidate,
                                uid: firebase.auth().currentUser.uid
                            });
                    }
                };

                peerConnections[firebase.auth().currentUser.uid] = peerConnection;

                // Gửi thông tin về peer mới vào Firestore
                firestore.collection("rooms").doc(currentRoom).collection("peers")
                    .add({ uid: firebase.auth().currentUser.uid })
                    .then(() => {
                        // Lấy offer từ người khác và trả lời bằng một answer
                        getOffersFromFirestore();
                    })
                    .catch((error) => {
                        console.error("Error sending peer info to Firestore: ", error);
                    });

                // Thêm stream của người dùng vào kết nối
                peerConnection.createOffer()
                    .then(offer => {
                        return peerConnection.setLocalDescription(offer);
                    })
                    .then(() => {
                        // Gửi offer cho người khác qua Firestore
                        firestore.collection("rooms").doc(currentRoom).collection("offers")
                            .add({
                                offer: peerConnection.localDescription,
                                uid: firebase.auth().currentUser.uid
                            });
                    })
                    .catch((error) => {
                        console.error("Error with WebRTC offer: ", error);
                    });
            })
            .catch((error) => {
                console.error("Error getting user media: ", error);
            });
    }

    // Lấy offer từ Firestore để trả lời với peer
    function getOffersFromFirestore() {
        firestore.collection("rooms").doc(currentRoom).collection("offers")
            .onSnapshot((snapshot) => {
                snapshot.forEach(doc => {
                    const offer = doc.data().offer;
                    if (offer && !peerConnections[doc.data().uid]) {
                        // Tạo peer connection và trả lời offer
                        const peerConnection = new RTCPeerConnection();
                        peerConnection.setRemoteDescription(offer);

                        peerConnection.createAnswer()
                            .then(answer => {
                                return peerConnection.setLocalDescription(answer);
                            })
                            .then(() => {
                                firestore.collection("rooms").doc(currentRoom).collection("answers")
                                    .add({
                                        answer: peerConnection.localDescription,
                                        uid: firebase.auth().currentUser.uid
                                    });
                            })
                            .catch((error) => {
                                console.error("Error with WebRTC answer: ", error);
                            });
                    }
                });
            });
    }

    // Mute / Unmute
    muteButton.addEventListener('click', () => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            muteButton.innerText = audioTrack.enabled ? 'Mute' : 'Unmute';
        }
    });

    // Leave Room
    leaveButton.addEventListener('click', () => {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            voiceTab.classList.add('hidden');
            chatSection.classList.remove('hidden');
        }
    });
</script>
