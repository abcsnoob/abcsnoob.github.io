<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat Room</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }
        #auth-section {
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="text"] {
            padding: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            width: 300px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #chat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hidden {
            display: none;
        }
        #voiceTab {
            margin: 20px;
        }
        #status {
            font-size: 18px;
            color: #555;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div id="auth-section">
        <button id="googleSignInButton">Sign In with Google</button>
    </div>

    <div id="chat-section" class="hidden">
        <div id="voiceTab" class="hidden">
            <button id="muteButton">Mute</button>
            <button id="leaveButton">Leave Room</button>
        </div>
        <div id="status"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDtcs0XkNhf7yFRTzPY-A9WYet35YjQVT8",
            authDomain: "abc-s-noob.firebaseapp.com",
            projectId: "abc-s-noob",
            storageBucket: "abc-s-noob.firebasestorage.app",
            messagingSenderId: "196660846002",
            appId: "1:196660846002:web:ce129820f388cc838658ab",
            measurementId: "G-LG5SWH89MG"
        };

        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // DOM elements
        const googleSignInButton = document.getElementById('googleSignInButton');
        const muteButton = document.getElementById('muteButton');
        const leaveButton = document.getElementById('leaveButton');
        const chatSection = document.getElementById('chat-section');
        const authSection = document.getElementById('auth-section');
        const voiceTab = document.getElementById('voiceTab');
        const statusDiv = document.getElementById('status');

        let localStream;
        let peerConnections = {};

        // Firebase Auth - Sign in with Google
        googleSignInButton.addEventListener('click', () => {
            // Mở tab đăng nhập Google
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_CLIENT_ID&redirect_uri=http://localhost:8000&response_type=token&scope=email`;
            const authWindow = window.open(googleAuthUrl, '_blank', 'width=600,height=800');

            // Lắng nghe tin nhắn từ tab mới
            window.addEventListener('message', (event) => {
                if (event.origin !== 'http://localhost:8000') return; // Kiểm tra origin đúng

                const token = event.data.token;
                if (token) {
                    // Đăng nhập với Firebase bằng token
                    auth.signInWithCustomToken(token).then((userCredential) => {
                        const user = userCredential.user;
                        statusDiv.innerHTML = `Logged in as ${user.displayName}`;
                        authSection.classList.add('hidden');
                        chatSection.classList.remove('hidden');
                        joinRoom(); // Tự động tham gia phòng trò chuyện
                    }).catch((error) => {
                        console.error("Error with Firebase login: ", error);
                    });

                    // Đóng tab đăng nhập khi đã xác thực thành công
                    authWindow.close();
                }
            });
        });

        // Join Room (phòng trò chuyện chung)
        function joinRoom() {
            chatSection.classList.add('hidden');
            voiceTab.classList.remove('hidden');
            // Thiết lập WebRTC cho trò chuyện âm thanh
            setupWebRTC();
        }

        // WebRTC setup để xử lý trò chuyện âm thanh giữa người dùng
        function setupWebRTC() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then((stream) => {
                    localStream = stream;
                    const audioTrack = localStream.getAudioTracks()[0];

                    // Tạo kết nối peer và xử lý ICE candidates
                    const peerConnection = new RTCPeerConnection();
                    peerConnection.addTrack(audioTrack);

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // Gửi ICE candidate cho người khác (sử dụng Firebase hoặc server signaling)
                        }
                    };

                    peerConnections[firebase.auth().currentUser.uid] = peerConnection;

                    // Thêm stream của người dùng vào kết nối
                    peerConnection.createOffer()
                        .then(offer => {
                            return peerConnection.setLocalDescription(offer);
                        })
                        .then(() => {
                            // Gửi offer cho người khác qua signaling (Firebase hoặc WebRTC signaling)
                        })
                        .catch((error) => {
                            console.error("Error with WebRTC offer: ", error);
                        });
                })
                .catch((error) => {
                    console.error("Error getting user media: ", error);
                });
        }

        // Mute / Unmute
        muteButton.addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                muteButton.innerText = audioTrack.enabled ? 'Mute' : 'Unmute';
            }
        });

        // Leave Room
        leaveButton.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                voiceTab.classList.add('hidden');
                chatSection.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
