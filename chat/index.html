<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat App</title>
    <script src="https://www.gstatic.com/firebasejs/9.18.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.18.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.18.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.18.1/firebase-functions.js"></script>
</head>
<body>
    <h2>Chat Firebase</h2>

    <!-- Đăng nhập -->
    <button id="loginBtn">Đăng Nhập</button>
    <input type="email" id="emailInput" placeholder="Nhập email" style="display:none;" />
    <input type="password" id="passwordInput" placeholder="Nhập mật khẩu" style="display:none;" />
    <button id="submitBtn" style="display:none;">Submit</button>

    <br><br>

    <!-- Phần Chat -->
    <div id="chatContainer" style="display:none;">
        <div id="chat"></div>
        <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." />
        <button id="sendMessageBtn">Gửi</button>
    </div>

    <!-- Phần Nhập mã xác thực -->
    <div id="codeVerification" style="display:none;">
        <input type="text" id="codeInput" placeholder="Nhập mã xác thực" />
        <button id="verifyCodeBtn">Xác Thực</button>
    </div>

    <script>
        // Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDtcs0XkNhf7yFRTzPY-A9WYet35YjQVT8",
  authDomain: "abc-s-noob.firebaseapp.com",
  databaseURL: "https://abc-s-noob-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "abc-s-noob",
  storageBucket: "abc-s-noob.firebasestorage.app",
  messagingSenderId: "196660846002",
  appId: "1:196660846002:web:ce129820f388cc838658ab",
  measurementId: "G-LG5SWH89MG"
};

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const functions = firebase.functions();

        let userEmail = "";
        let verificationCode = "";

        // Hiển thị input email và mật khẩu
        document.getElementById("loginBtn").addEventListener("click", () => {
            document.getElementById("emailInput").style.display = "block";
            document.getElementById("passwordInput").style.display = "block";
            document.getElementById("submitBtn").style.display = "block";
        });

        // Xử lý gửi email và mã xác thực
        document.getElementById("submitBtn").addEventListener("click", async () => {
            userEmail = document.getElementById("emailInput").value;
            const password = document.getElementById("passwordInput").value;

            if (userEmail && password) {
                try {
                    // Đăng nhập người dùng qua Firebase Authentication
                    await auth.signInWithEmailAndPassword(userEmail, password);
                    
                    // Tạo mã xác thực ngẫu nhiên 20 ký tự
                    verificationCode = generateCode();

                    // Gửi mã xác thực qua email
                    await sendVerificationCode(userEmail, verificationCode);

                    // Ẩn input email, mật khẩu và hiển thị phần nhập mã xác thực
                    document.getElementById("emailInput").style.display = "none";
                    document.getElementById("passwordInput").style.display = "none";
                    document.getElementById("submitBtn").style.display = "none";
                    document.getElementById("codeVerification").style.display = "block";
                } catch (error) {
                    console.error("Lỗi đăng nhập: ", error);
                    alert("Đăng nhập thất bại. Kiểm tra lại thông tin!");
                }
            } else {
                alert("Vui lòng nhập email và mật khẩu!");
            }
        });

        // Xác thực mã nhập vào
        document.getElementById("verifyCodeBtn").addEventListener("click", async () => {
            const enteredCode = document.getElementById("codeInput").value;

            if (enteredCode === verificationCode) {
                // Mã hợp lệ, tạo tài khoản và đăng nhập
                await auth.createUserWithEmailAndPassword(userEmail, "randomPassword").catch(error => {
                    console.error(error);
                });

                // Ẩn phần nhập mã và hiển thị phần chat
                document.getElementById("codeVerification").style.display = "none";
                document.getElementById("chatContainer").style.display = "block";
                document.getElementById("codeInput").value = "";

                // Xóa mã xác thực sau khi sử dụng
                await firestore.collection("verification_codes").doc(userEmail).delete();
            } else {
                alert("Mã không hợp lệ!");
            }
        });

        // Gửi tin nhắn
        document.getElementById("sendMessageBtn").addEventListener("click", async () => {
            const message = document.getElementById("messageInput").value;
            if (message) {
                await firestore.collection("messages").add({
                    user: userEmail,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById("messageInput").value = "";
            }
        });

        // Lắng nghe tin nhắn mới từ Firestore và hiển thị
        firestore.collection("messages").orderBy("timestamp").onSnapshot(snapshot => {
            const chatDiv = document.getElementById("chat");
            chatDiv.innerHTML = "";  // Clear current chat
            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = document.createElement("div");
                messageElement.textContent = `${message.user}: ${message.message}`;
                chatDiv.appendChild(messageElement);
            });
        });

        // Tạo mã xác thực ngẫu nhiên 20 ký tự
        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 20; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Gửi mã xác thực qua Firebase Function
        async function sendVerificationCode(email, code) {
            const sendCodeFunction = functions.httpsCallable('sendVerificationCode');
            await sendCodeFunction({ email, code });
        }
    </script>
</body>
</html>
