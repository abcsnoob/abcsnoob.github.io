<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Chat App with hCaptcha & Google Login</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    .auth-section input {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 200px;
    }

    .auth-section button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }

    .auth-section button:hover {
      background-color: #2980b9;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toggle-link {
      color: #3498db;
      cursor: pointer;
      text-decoration: underline;
    }

    #userSection {
      display: none;
    }
  </style>
</head>
<body>

  <header>
    <h1>Supabase Chat App</h1>
  </header>

  <!-- Authentication Section -->
  <div class="auth-section" id="authSection">
    <!-- Form Đăng Ký -->
    <div id="signUpForm">
      <input type="email" id="signUpEmail" placeholder="Email" required>
      <input type="password" id="signUpPassword" placeholder="Password" required>
      <div class="h-captcha" data-sitekey="9e92809a-9836-46ae-91e6-5968d65c2120"></div>
      <button onclick="signUp()">Sign Up</button>
      <p>Already have an account? <span class="toggle-link" onclick="toggleAuthForm('signIn')">Sign In</span></p>
    </div>

    <!-- Form Đăng Nhập -->
    <div id="signInForm" style="display: none;">
      <input type="email" id="signInEmail" placeholder="Email" required>
      <input type="password" id="signInPassword" placeholder="Password" required>
      <div class="h-captcha" data-sitekey="9e92809a-9836-46ae-91e6-5968d65c2120"></div>
      <button onclick="signIn()">Sign In</button>
      <button onclick="signInWithGoogle()">Sign In with Google</button>
      <p>Don't have an account? <span class="toggle-link" onclick="toggleAuthForm('signUp')">Sign Up</span></p>
    </div>

    <button id="logoutBtn" style="display: none;" onclick="logout()">Logout</button>
  </div>

  <!-- User Section -->
  <div id="userSection" style="display: none;">
    <h2>Welcome to your dashboard</h2>
    <div id="messages"></div>
    <div id="spinner" class="spinner"></div>
    <button onclick="loadMessages()">Load Messages</button>

    <div id="groupSection">
      <h2>Join a Group</h2>
      <input type="text" id="groupSearch" placeholder="Enter Group Code">
      <button onclick="joinGroup()">Join Group</button>
      <div id="groupsList"></div>
    </div>
  </div>

  <script>
    const supabase = createClient('https://kakbqeqyihbgioevzsrg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtha2JxZXF5aWhiZ2lvZXZ6c3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2ODc4NjksImV4cCI6MjA1OTI2Mzg2OX0.LRiRpup89IKy1m4SrqikyVQFEbDK8Kbo1NvOJCePCTM');

    let currentUser = null;

    // Chuyển đổi giữa form đăng nhập và đăng ký
    function toggleAuthForm(formType) {
      if (formType === 'signUp') {
        document.getElementById('signUpForm').style.display = 'block';
        document.getElementById('signInForm').style.display = 'none';
      } else {
        document.getElementById('signUpForm').style.display = 'none';
        document.getElementById('signInForm').style.display = 'block';
      }
    }

    // Đăng ký người dùng
    async function signUp() {
      const email = document.getElementById('signUpEmail').value;
      const password = document.getElementById('signUpPassword').value;
      const hcaptchaToken = hcaptcha.getResponse();

      if (!hcaptchaToken) {
        alert("Please complete the CAPTCHA.");
        return;
      }

      const { user, error } = await supabase.auth.signUp({ email, password });

      if (user) {
        console.log('User created:', user);
        alert("A verification email has been sent. Please verify your email address.");

        // Yêu cầu người dùng xác nhận email
        document.getElementById('signUpForm').style.display = 'none';
        document.getElementById('signInForm').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
      } else {
        console.error('Error signing up:', error.message);
        alert(error.message);
      }
    }

    // Đăng nhập người dùng
    async function signIn() {
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;

      const { user, session, error } = await supabase.auth.signIn({ email, password });

      if (error) {
        console.error('Error signing in:', error.message);
        alert(error.message);
      } else {
        console.log('User signed in:', user);
        alert('Login successful!');

        // Kiểm tra nếu email đã được xác thực
        if (!user.email_confirmed_at) {
          alert("Please verify your email before you can continue.");
        } else {
          document.getElementById('signInForm').style.display = 'none';
          document.getElementById('userSection').style.display = 'block';
          document.getElementById('logoutBtn').style.display = 'block';
        }
      }
    }

    // Đăng nhập với Google
    async function signInWithGoogle() {
      const { user, error } = await supabase.auth.signIn({
        provider: 'google',
      });

      if (error) {
        console.error('Error logging in with Google:', error.message);
        alert(error.message);
      } else {
        console.log('User logged in with Google:', user);
        alert('Google login successful!');
      }
    }

    // Đăng xuất
    async function logout() {
      const { error } = await supabase.auth.signOut();

      if (error) {
        console.error('Error logging out:', error.message);
      } else {
        document.getElementById('userSection').style.display = 'none';
        document.getElementById('signInForm').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'none';
        alert('Logged out successfully!');
      }
    }

    // Tải tin nhắn (ví dụ)
    async function loadMessages() {
      document.getElementById('spinner').style.display = 'block';

      const { data, error } = await supabase
        .from('messages')
        .select('*');

      if (error) {
        console.error('Error loading messages:', error.message);
      } else {
        document.getElementById('messages').innerHTML = data.map(msg => `<p>${msg.content}</p>`).join('');
      }

      document.getElementById('spinner').style.display = 'none';
    }

    // Tham gia nhóm (ví dụ)
    async function joinGroup() {
      const groupCode = document.getElementById('groupSearch').value;

      const { data, error } = await supabase
        .from('groups')
        .select('*')
        .eq('code', groupCode);

      if (error) {
        console.error('Error joining group:', error.message);
      } else if (data.length > 0) {
        alert(`Joined group: ${data[0].name}`);
      } else {
        alert('Group not found!');
      }
    }
  </script>
</body>
</html>
