<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat & Screen Share</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2F3136;
            color: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #auth-section, #chat-section {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #7289DA;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #5b6e98;
        }
        #voiceTab {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hidden {
            display: none;
        }
        video {
            margin-top: 10px;
            width: 300px;
            height: 200px;
        }
    </style>
</head>
<body>
    <div id="auth-section">
        <button id="googleSignInButton">Sign In with Google</button>
    </div>

    <div id="chat-section" class="hidden">
        <div id="voiceTab" class="hidden">
            <video id="localVideo" autoplay muted></video>
            <video id="remoteVideo" autoplay></video>
            <button id="startVoice">Start Voice</button>
            <button id="muteButton">Mute</button>
            <button id="shareScreenButton">Share Screen</button>
            <button id="leaveButton">Leave Room</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDtcs0XkNhf7yFRTzPY-A9WYet35YjQVT8",
            authDomain: "abc-s-noob.firebaseapp.com",
            projectId: "abc-s-noob",
            storageBucket: "abc-s-noob.firebasestorage.app",
            messagingSenderId: "196660846002",
            appId: "1:196660846002:web:ce129820f388cc838658ab",
            measurementId: "G-LG5SWH89MG"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // DOM elements
        const googleSignInButton = document.getElementById('googleSignInButton');
        const startVoiceButton = document.getElementById('startVoice');
        const muteButton = document.getElementById('muteButton');
        const leaveButton = document.getElementById('leaveButton');
        const shareScreenButton = document.getElementById('shareScreenButton');
        const chatSection = document.getElementById('chat-section');
        const authSection = document.getElementById('auth-section');
        const voiceTab = document.getElementById('voiceTab');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        let localStream;
        let peerConnection;
        let screenStream;

        // Check if user is already logged in
        if(localStorage.getItem("user")) {
            authSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
            voiceTab.classList.remove('hidden');
        }

        // Sign in with Google
        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    localStorage.setItem("user", JSON.stringify(user)); // Save user in localStorage
                    authSection.classList.add('hidden');
                    chatSection.classList.remove('hidden');
                    voiceTab.classList.remove('hidden');
                }).catch((error) => {
                    console.error("Error during Google sign-in: ", error);
                });
        });

        // Start voice chat
        startVoiceButton.addEventListener('click', () => {
            startVoiceChat();
        });

        // Mute / Unmute button
        muteButton.addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                muteButton.innerText = audioTrack.enabled ? 'Mute' : 'Unmute';
            }
        });

        // Share screen button
        shareScreenButton.addEventListener('click', () => {
            shareScreen();
        });

        // Leave the room
        leaveButton.addEventListener('click', () => {
            leaveRoom();
        });

        // Start voice chat function
        function startVoiceChat() {
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                .then((stream) => {
                    localStream = stream;
                    localVideo.srcObject = localStream;
                    const audioTrack = localStream.getAudioTracks()[0];

                    peerConnection = new RTCPeerConnection();

                    peerConnection.addTrack(audioTrack);

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // Send ICE candidate to the remote peer
                        }
                    };

                    peerConnection.createOffer()
                        .then(offer => {
                            return peerConnection.setLocalDescription(offer);
                        })
                        .then(() => {
                            // Send the offer to remote peer via signaling server
                        })
                        .catch((error) => {
                            console.error("Error during WebRTC offer:", error);
                        });
                }).catch((error) => {
                    console.error("Error getting user media:", error);
                });
        }

        // Share screen function
        function shareScreen() {
            navigator.mediaDevices.getDisplayMedia({ video: true })
                .then((stream) => {
                    screenStream = stream;
                    const screenTrack = screenStream.getVideoTracks()[0];
                    localVideo.srcObject = screenStream;

                    // Update peer connection with new screen track
                    const sender = peerConnection.getSenders().find(sender => sender.track.kind === "video");
                    sender.replaceTrack(screenTrack);
                }).catch((error) => {
                    console.error("Error sharing screen:", error);
                });
        }

        // Leave room and stop streams
        function leaveRoom() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            peerConnection.close();
            voiceTab.classList.add('hidden');
            chatSection.classList.remove('hidden');
            localStorage.removeItem("user"); // Remove user from localStorage on leave
        }
    </script>
</body>
</html>
