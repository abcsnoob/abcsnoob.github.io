<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firebase Chat</title>
</head>
<body>
  <h1>Firebase Chat</h1>

  <!-- Form Đăng nhập -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required><br>
    <input type="password" id="loginPassword" placeholder="Mật khẩu" required><br>
    <button type="submit">Đăng nhập</button>
  </form>

  <!-- Form Đăng ký -->
  <form id="registerForm" style="display: none;">
    <p>Tài khoản chưa tồn tại. Vui lòng đăng ký:</p>
    <input type="email" id="registerEmail" placeholder="Email" required><br>
    <input type="password" id="registerPassword" placeholder="Mật khẩu" required><br>
    <button type="submit">Đăng ký</button>
  </form>

  <!-- Khu vực chat -->
  <div id="chatBox" style="display: none;">
    <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #ccc;"></div>
    <input type="text" id="messageInput" placeholder="Nhập tin nhắn">
    <button id="sendButton">Gửi</button>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Cấu hình Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDtcs0XkNhf7yFRTzPY-A9WYet35YjQVT8",
  authDomain: "abc-s-noob.firebaseapp.com",
  databaseURL: "https://abc-s-noob-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "abc-s-noob",
  storageBucket: "abc-s-noob.firebasestorage.app",
  messagingSenderId: "196660846002",
  appId: "1:196660846002:web:ce129820f388cc838658ab",
  measurementId: "G-LG5SWH89MG"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Đăng nhập
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) return alert("Nhập đầy đủ email và mật khẩu");
      if (password.length < 6) return alert("Mật khẩu phải ≥ 6 ký tự");

      auth.signInWithEmailAndPassword(email, password)
        .then(() => showChat())
        .catch((error) => {
          console.error("Lỗi đăng nhập: ", error);
          if (error.code === "auth/user-not-found") {
            // Chuyển sang đăng ký
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("registerForm").style.display = "block";
            document.getElementById("registerEmail").value = email;
            document.getElementById("registerPassword").value = password;
          } else if (error.code === "auth/wrong-password") {
            alert("Sai mật khẩu!");
          } else {
            alert("Lỗi đăng nhập: " + error.message);
          }
        });
    });

    // Đăng ký
    document.getElementById("registerForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("registerEmail").value.trim();
      const password = document.getElementById("registerPassword").value;

      if (!email || !password) return alert("Nhập đầy đủ email và mật khẩu");
      if (password.length < 6) return alert("Mật khẩu phải ≥ 6 ký tự");

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => showChat())
        .catch((error) => {
          console.error("Lỗi đăng ký: ", error);
          alert("Lỗi đăng ký: " + error.message);
        });
    });

    // Gửi tin nhắn
    document.getElementById("sendButton").addEventListener("click", function() {
      const message = document.getElementById("messageInput").value;
      const user = auth.currentUser;
      if (!user || !message.trim()) return;

      db.collection("messages").add({
        text: message,
        uid: user.uid,
        email: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById("messageInput").value = "";
      });
    });

    // Xem tin nhắn realtime
    db.collection("messages").orderBy("createdAt").onSnapshot((snapshot) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        const div = document.createElement("div");
        div.textContent = `${data.email}: ${data.text}`;
        messagesDiv.appendChild(div);
      });
    });

    function showChat() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("chatBox").style.display = "block";
    }
  </script>
</body>
</html>
